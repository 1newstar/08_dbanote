---
title: 老长宇系统ORACLE数据库迁移到12C
date: 2017-06-14
categories:
- workbook
---

## 安装要迁移目标服务器的操作系统
迁移目标服务器的操作系统选用最新的Oracle Linux 7.3 x64，安装图解：[在DELL_R730物理机上安装配置Oracle_Linux_7.3](/2017/05/24/linux/20170524_在DELL_R730物理机上安装配置Oracle_Linux_7.3/)
<!-- more -->

## 系统必要配置及软件包安装
### 查看系统基本信息
``` perl
cat /etc/redhat-release 
Red Hat Enterprise Linux Server release 7.3 (Maipo)

uname -a
Linux orcl12 4.1.12-61.1.18.el7uek.x86_64 #2 SMP Fri Nov 4 15:48:30 PDT 2016 x86_64 x86_64 x86_64 GNU/Linux

cat /proc/meminfo | grep HugePages
AnonHugePages:     26624 kB
HugePages_Total:       0
HugePages_Free:        0
HugePages_Rsvd:        0
HugePages_Surp:        0

df -hT
Filesystem          Type      Size  Used Avail Use% Mounted on
devtmpfs            devtmpfs   63G     0   63G   0% /dev
tmpfs               tmpfs      63G     0   63G   0% /dev/shm
tmpfs               tmpfs      63G   18M   63G   1% /run
tmpfs               tmpfs      63G     0   63G   0% /sys/fs/cgroup
/dev/mapper/ol-root xfs       100G  1.2G   99G   2% /
/dev/sda2           xfs      1014M  148M  867M  15% /boot
/dev/sda1           vfat      200M  9.5M  191M   5% /boot/efi
tmpfs               tmpfs      13G     0   13G   0% /run/user/0

systemctl list-unit-files | grep enabled
auditd.service                              enabled 
autovt@.service                             enabled 
crond.service                               enabled 
dbus-org.fedoraproject.FirewallD1.service   enabled 
dbus-org.freedesktop.NetworkManager.service enabled 
dbus-org.freedesktop.nm-dispatcher.service  enabled 
firewalld.service                           enabled 
getty@.service                              enabled 
irqbalance.service                          enabled 
lvm2-monitor.service                        enabled 
microcode.service                           enabled 
multipathd.service                          enabled 
NetworkManager-dispatcher.service           enabled 
NetworkManager.service                      enabled 
postfix.service                             enabled 
rsyslog.service                             enabled 
sshd.service                                enabled 
systemd-readahead-collect.service           enabled 
systemd-readahead-drop.service              enabled 
systemd-readahead-replay.service            enabled 
tuned.service                               enabled 
dm-event.socket                             enabled 
lvm2-lvmetad.socket                         enabled 
lvm2-lvmpolld.socket                        enabled 
default.target                              enabled 
multi-user.target                           enabled 
remote-fs.target                            enabled 
runlevel2.target                            enabled 
runlevel3.target                            enabled 
runlevel4.target                            enabled 

# 网络配置
cat /etc/sysconfig/network-scripts/ifcfg-em2
TYPE="Ethernet"
BOOTPROTO="none"
DEFROUTE="yes"
IPV4_FAILURE_FATAL="no"
IPV6INIT="no"
IPV6_AUTOCONF="yes"
IPV6_DEFROUTE="yes"
IPV6_PEERDNS="yes"
IPV6_PEERROUTES="yes"
IPV6_FAILURE_FATAL="no"
IPV6_ADDR_GEN_MODE="stable-privacy"
NAME="em2"
UUID="7946dd31-b833-49db-9243-7c9d6657e76f"
DEVICE="em2"
ONBOOT="yes"
IPADDR="10.245.230.5"
PREFIX="24"
GATEWAY="10.245.230.254"

# 主机名查看/配置
hostnamectl
hostnamectl --static set-hostname orcl12

cat /sys/block/sda/queue/scheduler 
noop [deadline] cfq 
```

### 所需软件包安装
``` perl
mkdir /media/disk
mount -o loop /media/Oracle_Linux_7.3_x86_64.iso /media/disk
cp /etc/yum.repos.d/public-yum-ol7.repo public-yum-ol7.repo.bak
vi /etc/yum.repos.d/public-yum-ol7.repo
#----------------------------------------------
[ol7_latest]
name=Oracle Linux $releasever Latest ($basearch)
baseurl=file:///media/disk
gpgcheck=0
enabled=1
#----------------------------------------------

yum -y install oracle-database-server-12cR2-preinstall.x86_64
yum -y install lrzsz tigervnc-server readline-devel.x86_64 ntpdate gcc

crontab -e
00 00 * * * /usr/sbin/ntpdate 10.240.3.245;/sbin/hwclock -w

# 使用rz工具上传jdk和rlwrap安装包到当前目录
yum -y localinstall --nogpgcheck jdk-8u131-linux-x64.rpm

tar xvpf rlwrap-0.42.tar.gz
cd rlwrap-0.42
./configure
make && make install
```

### 创建/配置所需用户及目录
``` perl
id oracle
uid=54321(oracle) gid=54321(oinstall) groups=54321(oinstall),54322(dba)

groupadd -g 54323 oper
groupadd -g 54324 backupdba
groupadd -g 54325 dgdba
groupadd -g 54326 kmdba
groupadd -g 54327 asmdba
groupadd -g 54328 asmoper
groupadd -g 54329 asmadmin
groupadd -g 54330 racdba

usermod -u 54321 -g oinstall -G dba,oper,asmdba oracle
useradd -u 54322 -g oinstall -G dba,oper,backupdba,dgdba,kmdba,asmdba,asmoper,asmadmin,racdba grid
usermod -u 54322 -g oinstall -G dba,oper,backupdba,dgdba,kmdba,asmdba,asmoper,asmadmin,racdba grid

echo "12jca7or1Q" | passwd --stdin oracle
echo "12jca7or1Q" | passwd --stdin grid

mkdir -p /u01/app/grid
mkdir -p /u01/app/12.2.0/grid
mkdir -p /u01/app/oracle
chown -R grid:oinstall /u01
chown oracle:oinstall /u01/app/oracle
chmod -R 775 /u01/

# grid用户环境
echo "export ORACLE_SID=+ASM" >> /home/grid/.bash_profile
echo "export ORACLE_BASE=/u01/app/grid" >> /home/grid/.bash_profile
echo "export ORACLE_HOME=/u01/app/12.2.0/grid" >> /home/grid/.bash_profile
echo "export LD_LIBRARY_PATH=\$ORACLE_HOME/lib" >> /home/grid/.bash_profile
echo "export PATH=\$PATH:\$HOME/bin:\$ORACLE_HOME/bin:\$ORACLE_HOME/OPatch" >> /home/grid/.bash_profile
echo "export NLS_LANG=AMERICAN_AMERICA.ZHS16GBK" >> /home/grid/.bash_profile
echo "export NLS_DATE_FORMAT='yyyy-mm-dd hh24:mi:ss'" >> /home/grid/.bash_profile
echo "alias sqlplus='rlwrap sqlplus'" >> /home/grid/.bash_profile
echo "alias asmcmd='rlwrap asmcmd'" >> /home/grid/.bash_profile
echo "alias rman='rlwrap rman'" >> /home/grid/.bash_profile
echo "alias dgmgrl='rlwrap dgmgrl'" >> /home/grid/.bash_profile

# oracle用户环境
echo "export ORACLE_SID=orcl12" >> /home/oracle/.bash_profile
echo "export ORACLE_BASE=/u01/app/oracle" >> /home/oracle/.bash_profile
echo "export ORACLE_HOME=\$ORACLE_BASE/product/12.2.0/db_1" >> /home/oracle/.bash_profile
echo "export LD_LIBRARY_PATH=\$ORACLE_HOME/lib" >> /home/oracle/.bash_profile
echo "export PATH=\$PATH:\$HOME/bin:\$ORACLE_HOME/bin:\$ORACLE_HOME/OPatch" >> /home/oracle/.bash_profile
echo "export NLS_LANG=AMERICAN_AMERICA.ZHS16GBK" >> /home/oracle/.bash_profile
echo "export NLS_DATE_FORMAT='yyyy-mm-dd hh24:mi:ss'" >> /home/oracle/.bash_profile
echo "alias sqlplus='rlwrap sqlplus'" >> /home/oracle/.bash_profile
echo "alias asmcmd='rlwrap asmcmd'" >> /home/oracle/.bash_profile
echo "alias rman='rlwrap rman'" >> /home/oracle/.bash_profile
echo "alias dgmgrl='rlwrap dgmgrl'" >> /home/oracle/.bash_profile

# root用户环境
echo "export GRID_HOME=/u01/app/12.2.0/grid" >> /root/.bash_profile
echo "export PATH=\$PATH:\$GRID_HOME/bin:\$GRID_HOME/OPatch" >> /root/.bash_profile
```

### 配置共享存储/磁盘
``` perl
fdisk -l /dev/sda
#--------------------------------------------------------------------------------------------
WARNING: fdisk GPT support is currently new, and therefore in an experimental phase. Use at your own discretion.

Disk /dev/sda: 1798.6 GB, 1798646267904 bytes, 3512980992 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk label type: gpt


#         Start          End    Size  Type            Name
 1         2048       411647    200M  EFI System      EFI System Partition
 2       411648      2508799      1G  Microsoft basic 
 3      2508800    279334911    132G  Linux LVM       
 4    279334912    698765311    200G  Linux filesyste 
 5    698765312   1118195711    200G  Linux filesyste 
 6   1118195712   1537626111    200G  Linux filesyste 
 7   1537626112   1957056511    200G  Linux filesyste 
 8   1957056512   2376486911    200G  Linux filesyste 
 9   2376486912   2795917311    200G  Linux filesyste 
10   2795917312   3512980958  341.9G  Linux filesyste 
#--------------------------------------------------------------------------------------------

mkfs.xfs /dev/sda10
#--------------------------------------------------------------------------------------------
meta-data=/dev/sda10             isize=256    agcount=4, agsize=22408239 blks
         =                       sectsz=512   attr=2, projid32bit=1
         =                       crc=0        finobt=0, sparse=0
data     =                       bsize=4096   blocks=89632955, imaxpct=25
         =                       sunit=0      swidth=0 blks
naming   =version 2              bsize=4096   ascii-ci=0 ftype=0
log      =internal log           bsize=4096   blocks=43766, version=2
         =                       sectsz=512   sunit=0 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
#--------------------------------------------------------------------------------------------

mkdir /oradata
mount /dev/sda10 /oradata
chmod oracle:oinstall /oradata

echo "/dev/sda10              /oradata                xfs     defaults        0 0" >> /etc/fstab

df -hT
#--------------------------------------------------------------------------------------------
Filesystem          Type      Size  Used Avail Use% Mounted on
devtmpfs            devtmpfs   63G     0   63G   0% /dev
tmpfs               tmpfs      63G     0   63G   0% /dev/shm
tmpfs               tmpfs      63G  9.1M   63G   1% /run
tmpfs               tmpfs      63G     0   63G   0% /sys/fs/cgroup
/dev/mapper/ol-root xfs       100G   13G   88G  13% /
/dev/sda2           xfs      1014M  148M  867M  15% /boot
/dev/sda1           vfat      200M  9.5M  191M   5% /boot/efi
tmpfs               tmpfs      13G     0   13G   0% /run/user/0
/dev/sda10          xfs       342G   33M  342G   1% /oradata
#--------------------------------------------------------------------------------------------

# 在centos7/redhat7 版本中的udev已不再单独是一个包，而是在systemd包中包含了udev工具。
# rule规则除了/etc/udev/rules.d目录，还有/usr/lib/udev/rules.d/ 目录。
echo "ACTION==\"add\", KERNEL==\"sda4\", RUN+=\"/bin/raw /dev/raw/raw1 %N\"" >> /usr/lib/udev/rules.d/60-raw.rules
echo "ACTION==\"add\", KERNEL==\"sda5\", RUN+=\"/bin/raw /dev/raw/raw2 %N\"" >> /usr/lib/udev/rules.d/60-raw.rules
echo "ACTION==\"add\", KERNEL==\"sda6\", RUN+=\"/bin/raw /dev/raw/raw3 %N\"" >> /usr/lib/udev/rules.d/60-raw.rules
echo "ACTION==\"add\", KERNEL==\"sda7\", RUN+=\"/bin/raw /dev/raw/raw4 %N\"" >> /usr/lib/udev/rules.d/60-raw.rules
echo "ACTION==\"add\", KERNEL==\"sda8\", RUN+=\"/bin/raw /dev/raw/raw5 %N\"" >> /usr/lib/udev/rules.d/60-raw.rules
echo "ACTION==\"add\", KERNEL==\"sda9\", RUN+=\"/bin/raw /dev/raw/raw6 %N\"" >> /usr/lib/udev/rules.d/60-raw.rules
echo "ACTION==\"add\", KERNEL==\"raw*\", OWNER==\"oracle\", GROUP==\"oinstall\", MODE==\"0660\"" >> /usr/lib/udev/rules.d/60-raw.rules

cp /usr/lib/udev/rules.d/60-raw.rules /etc/udev/rules.d/
systemctl restart systemd-udev-trigger.service

ll /dev/raw/*
crw-rw---- 1 oracle oinstall 162, 1 Jun 14 18:05 /dev/raw/raw1
crw-rw---- 1 oracle oinstall 162, 2 Jun 14 18:05 /dev/raw/raw2
crw-rw---- 1 oracle oinstall 162, 3 Jun 14 18:05 /dev/raw/raw3
crw-rw---- 1 oracle oinstall 162, 4 Jun 14 18:05 /dev/raw/raw4
crw-rw---- 1 oracle oinstall 162, 5 Jun 14 18:05 /dev/raw/raw5
crw-rw---- 1 oracle oinstall 162, 6 Jun 14 18:05 /dev/raw/raw6
crw-rw---- 1 oracle oinstall 162, 0 Jun 14 18:05 /dev/raw/rawctl
```

### 系统必要配置
``` perl
echo "10.245.230.5  orcl12  orcl12.ydgwql.cn" >> /etc/hosts
sed -i "s/SELINUX=enforcing/SELINUX=disabled/g" /etc/selinux/config

setenforce 0

# 禁用防火墙
systemctl stop firewalld
systemctl disable firewalld
systemctl status firewalld

sysctl -p
fs.file-max = 6815744
kernel.sem = 250 32000 100 128
kernel.shmmni = 4096
kernel.shmall = 1073741824
kernel.shmmax = 70368744177664
kernel.panic_on_oops = 1
net.core.rmem_default = 262144
net.core.rmem_max = 4194304
net.core.wmem_default = 262144
net.core.wmem_max = 1048576
net.ipv4.conf.all.rp_filter = 2
net.ipv4.conf.default.rp_filter = 2
fs.aio-max-nr = 1048576
net.ipv4.ip_local_port_range = 9000 65500

# kernel.shmmax的值按物理内存大小计算
# 128G:kernel.shmmax = (128G*1024*1024*1024*1024)*50% = 70368744177664
sed -i "s/kernel.shmmax = 4398046511104/kernel.shmmax = 70368744177664/g" /etc/sysctl.conf

sysctl -p
fs.file-max = 6815744
kernel.sem = 250 32000 100 128
kernel.shmmni = 4096
kernel.shmall = 1073741824
kernel.shmmax = 70368744177664
kernel.panic_on_oops = 1
net.core.rmem_default = 262144
net.core.rmem_max = 4194304
net.core.wmem_default = 262144
net.core.wmem_max = 1048576
net.ipv4.conf.all.rp_filter = 2
net.ipv4.conf.default.rp_filter = 2
fs.aio-max-nr = 1048576
net.ipv4.ip_local_port_range = 9000 65500

# memlock=90 % of RAM=128g*1024*1024*0.9 = 120795955.2  = 120795956
echo "oracle   soft   nofile    1024" >> /etc/security/limits.conf
echo "oracle   hard   nofile    65536" >> /etc/security/limits.conf
echo "oracle   soft   nproc     2047" >> /etc/security/limits.conf
echo "oracle   hard   nproc     16384" >> /etc/security/limits.conf
echo "oracle   soft   stack     10240" >> /etc/security/limits.conf
echo "oracle   hard   stack     32768" >> /etc/security/limits.conf
echo "oracle   hard   memlock   120795956" >> /etc/security/limits.conf
echo "oracle   soft   memlock   120795956" >> /etc/security/limits.conf
echo "grid     soft   nofile    1024" >> /etc/security/limits.conf
echo "grid     hard   nofile    65536" >> /etc/security/limits.conf
echo "grid     soft   nproc     2047" >> /etc/security/limits.conf
echo "grid     hard   nproc     16384" >> /etc/security/limits.conf
echo "grid     soft   stack     10240" >> /etc/security/limits.conf
echo "grid     hard   stack     32768" >> /etc/security/limits.conf
echo "grid     hard   memlock   120795956" >> /etc/security/limits.conf
echo "grid     soft   memlock   120795956" >> /etc/security/limits.conf

## 查找到存在vm.swappiness参数的配置文件
find /usr/lib/tuned -name '*.conf' -type f -exec grep "vm.swappiness" {} \+
----------------------------------------------------------
/usr/lib/tuned/latency-performance/tuned.conf:vm.swappiness=10
/usr/lib/tuned/throughput-performance/tuned.conf:vm.swappiness=10
/usr/lib/tuned/virtual-guest/tuned.conf:vm.swappiness = 30
----------------------------------------------------------
# 把以上3个文件中的vm.swappiness的值都修改为0
sed -i "s/vm.swappiness=10/vm.swappiness=0/g" /usr/lib/tuned/latency-performance/tuned.conf
sed -i "s/vm.swappiness=10/vm.swappiness=0/g" /usr/lib/tuned/throughput-performance/tuned.conf
sed -i "s/vm.swappiness = 30/vm.swappiness = 0/g" /usr/lib/tuned/virtual-guest/tuned.conf
```


## 安装GI
``` perl
mkdir /oradata/software
cd /oradata/software
# 使用rz工具上传安装所需GI及DATABASE安装包
rz

# 安装cvuqdisk
## cvuqdisk存于oracle安装介质的rpm目录下，解压缩database的安装介质即可看到此包
## root用户下
cd /oradata/software/database/rpm/
export CVUQDISK_GRP=asmadmin
rpm -ivh cvuqdisk-1.0.10-1.rpm

su - grid
cd /u01/app/12.2.0/grid
unzip -q /oradata/software/V840012-01.zip

export DISPLAY=10.240.4.150:0.0
./gridSetup.sh

SYS/ASMSNMP
j12ja7or1Q

# root用户执行
/u01/app/oraInventory/orainstRoot.sh
/u01/app/12.2.0/grid/root.sh

# 验证GI安装是否正常
crsctl stat res -t
--------------------------------------------------------------------------------
Name           Target  State        Server                   State details       
--------------------------------------------------------------------------------
Local Resources
--------------------------------------------------------------------------------
ora.DATA.dg
               ONLINE  ONLINE       orcl12                   STABLE
ora.LISTENER.lsnr
               ONLINE  ONLINE       orcl12                   STABLE
ora.asm
               ONLINE  ONLINE       orcl12                   Started,STABLE
ora.ons
               OFFLINE OFFLINE      orcl12                   STABLE
--------------------------------------------------------------------------------
Cluster Resources
--------------------------------------------------------------------------------
ora.cssd
      1        ONLINE  ONLINE       orcl12                   STABLE
ora.diskmon
      1        OFFLINE OFFLINE                               STABLE
ora.driver.afd
      1        ONLINE  ONLINE       orcl12                   STABLE
ora.evmd
      1        ONLINE  ONLINE       orcl12                   STABLE
--------------------------------------------------------------------------------
```

图形化安装步骤：
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_grid_install_01.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_grid_install_02.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_grid_install_03.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_grid_install_04.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_grid_install_05.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_grid_install_06.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_grid_install_07.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_grid_install_08.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_grid_install_09.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_grid_install_10.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_grid_install_11.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_grid_install_12.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_grid_install_13.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_grid_install_14.png)

## ASMCA创建磁盘组
``` perl
su - grid
asmca
```

![](http://oligvdnzp.bkt.clouddn.com/0615_12c_asmca_01.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_asmca_02.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_asmca_03.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_asmca_04.png)

## 安装数据库软件
``` perl
su - oracle
cd /oradata/software/database/
export DISPLAY=10.240.4.150:0.0
./runInstaller

# TFA是12C自带的日志分析工具,可以快速分析当前数据库日志
/u01/app/oracle/product/12.2.0/db_1/root.sh
Do you want to setup Oracle Trace File Analyzer (TFA) now ? yes|[no] : 
yes    # 默认是no，输入yes开始安装
```

![](http://oligvdnzp.bkt.clouddn.com/0615_12c_database_install_01.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_database_install_02.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_database_install_03.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_database_install_04.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_database_install_05.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_database_install_06.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_database_install_07.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_database_install_08.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_database_install_09.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_database_install_10.png)

## DBCA创建CDB数据库
``` perl
dbca
```

![](http://oligvdnzp.bkt.clouddn.com/0615_12c_dbca_01.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_dbca_02.png)
若要定制安装组件，选择custom database
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_dbca_03.png)
可以直接创建一个PDB，也可以只创建CDB，之后用命令来创建PDB
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_dbca_04.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_dbca_05.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_dbca_06.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_dbca_07.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_dbca_08.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_dbca_09.png)
SGA=1280.56= 72G  PGA=72*0.15 =10G
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_dbca_10.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_dbca_11.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_dbca_12.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_dbca_13.png)
SYS/ASMSNMP j12ja7or1Q
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_dbca_14.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_dbca_15.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_dbca_16.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_dbca_17.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_dbca_18.png)
![](http://oligvdnzp.bkt.clouddn.com/0615_12c_dbca_19.png)

## 设置hugepage
参考：[hugepage计算脚本](/2017/05/08/oracle/hugepage计算脚本/)
``` perl
# root用户下
echo "vm.nr_hugepages = 36866" >> /etc/sysctl.conf

# 为使用配置生效，需重启服务器
crsctl stop res -all
crsctl start res -all
```

## 创建PDB
### 创建MISORA PDB
``` perl
show pdbs;

    CON_ID CON_NAME                       OPEN MODE  RESTRICTED
---------- ------------------------------ ---------- ----------
         2 PDB$SEED                       READ ONLY  NO

create pluggable database misora admin user pdb_mgr identified by "j12ja7or1Q"
default tablespace mis_data datafile
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited;

alter pluggable database misora open;
alter pluggable database misora save state;

alter session set container=misora;

create tablespace mis_index datafile
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited;

create temporary tablespace mis_temp tempfile
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited;

# 若创建出错，可使用以下语句删除表空间(原库里临时表空间使用mis_temp，这里用TEMP保持统一)
drop tablespace mis_temp including contents and datafiles;

select FILE_NAME from dba_data_files
union all
select FILE_NAME from dba_temp_files order by 1;

FILE_NAME
--------------------------------------------------------------------------------
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_data.257.947174203
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_data.258.947174169
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_data.272.947174135
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_data.281.947174309
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_data.282.947174239
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_data.283.947174275
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_data.284.947174345
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_data.285.947174381
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_data.287.947174415
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_data.288.947174451
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_data.289.947174487
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_data.290.947174523
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_data.291.947174559
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_data.292.947174595
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_index.293.947174657
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_index.294.947174693
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_index.295.947174731
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_index.296.947174767
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_index.297.947174803
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/sysaux.266.947174121
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/system.273.947174121
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/undotbs1.274.947174121
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/TEMPFILE/mis_temp.312.947177031
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/TEMPFILE/mis_temp.313.947177031
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/TEMPFILE/temp.267.947174125

alter profile default limit FAILED_LOGIN_ATTEMPTS 100;
alter profile default limit PASSWORD_LIFE_TIME unlimited;

!mkdir /oradata/dumpdir
create or replace directory dump_dir as '/oradata/dumpdir';

set line 150
col OWNER for a10
col DIRECTORY_NAME for a20
col DIRECTORY_PATH for a40
select * from dba_directories where DIRECTORY_NAME='DUMP_DIR';

OWNER      DIRECTORY_NAME       DIRECTORY_PATH                           ORIGIN_CON_ID
---------- -------------------- ---------------------------------------- -------------
SYS        DUMP_DIR             /oradata/dumpdir                                     5

col USERNAME for a20 
select USERNAME,DEFAULT_TABLESPACE,TEMPORARY_TABLESPACE from dba_users where account_status='OPEN';

USERNAME             DEFAULT_TABLESPACE             TEMPORARY_TABLESPACE
-------------------- ------------------------------ ------------------------------
SYS                  SYSTEM                         TEMP
SYSTEM               SYSTEM                         TEMP
YDVIEW               MIS_DATA                       TEMP
YD                   MIS_DATA                       TEMP
CY_EXP               MIS_DATA                       TEMP
PDB_MGR              MIS_DATA                       TEMP

alter tablespace temp add tempfile '+DATA' size 1g autoextend on next 500m maxsize unlimited;
```

### 创建VIP PDB
``` perl
conn / as sysdba
show pdbs;

    CON_ID CON_NAME                       OPEN MODE  RESTRICTED
---------- ------------------------------ ---------- ----------
         2 PDB$SEED                       READ ONLY  NO
         5 MISORA                         READ WRITE NO

create pluggable database vip admin user pdb_mgr identified by "j12ja7or1Q"
default tablespace vipmis datafile
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited;

alter pluggable database vip open;
alter pluggable database vip save state;

alter session set container=vip;

select FILE_NAME from dba_data_files order by 1;

FILE_NAME
--------------------------------------------------------------------------------
+DATA/ORCL12/525F6941825FE32DE05305E6F50A9CD5/DATAFILE/sysaux.298.947169131
+DATA/ORCL12/525F6941825FE32DE05305E6F50A9CD5/DATAFILE/system.299.947169131
+DATA/ORCL12/525F6941825FE32DE05305E6F50A9CD5/DATAFILE/undotbs1.300.947169131
+DATA/ORCL12/525F6941825FE32DE05305E6F50A9CD5/DATAFILE/vipmis.302.947169285
+DATA/ORCL12/525F6941825FE32DE05305E6F50A9CD5/DATAFILE/vipmis.303.947169321
+DATA/ORCL12/525F6941825FE32DE05305E6F50A9CD5/DATAFILE/vipmis.304.947169355
+DATA/ORCL12/525F6941825FE32DE05305E6F50A9CD5/DATAFILE/vipmis.305.947169391
+DATA/ORCL12/525F6941825FE32DE05305E6F50A9CD5/DATAFILE/vipmis.306.947169427
+DATA/ORCL12/525F6941825FE32DE05305E6F50A9CD5/DATAFILE/vipmis.307.947169463
+DATA/ORCL12/525F6941825FE32DE05305E6F50A9CD5/DATAFILE/vipmis.308.947169499
+DATA/ORCL12/525F6941825FE32DE05305E6F50A9CD5/DATAFILE/vipmis.309.947169535
+DATA/ORCL12/525F6941825FE32DE05305E6F50A9CD5/DATAFILE/vipmis.310.947169571
+DATA/ORCL12/525F6941825FE32DE05305E6F50A9CD5/DATAFILE/vipmis.311.947169609

create or replace directory dump_dir as '/oradata/dumpdir';

set line 150
col OWNER for a10
col DIRECTORY_NAME for a20
col DIRECTORY_PATH for a40
select * from dba_directories where DIRECTORY_NAME='DUMP_DIR';

OWNER      DIRECTORY_NAME       DIRECTORY_PATH                           ORIGIN_CON_ID
---------- -------------------- ---------------------------------------- -------------
SYS        DUMP_DIR             /oradata/dumpdir                                     4

```

## 配置Listener和tnsname
``` perl
su - grid
vi $ORACLE_HOME/network/admin/listener.ora
#-----------------------------------------------------------------------------------------
# 添加以下内容
SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (GLOBAL_DBNAME = misora)
      (ORACLE_HOME = /u01/app/oracle/product/12.2.0/db_1)
      (SID_NAME = orcl12)
    )
    (SID_DESC =
      (GLOBAL_DBNAME = vip)
      (ORACLE_HOME = /u01/app/oracle/product/12.2.0/db_1)
      (SID_NAME = orcl12)
    )
)
#-----------------------------------------------------------------------------------------

lsnrctl reload

exit
su - oracle
vi $ORACLE_HOME/network/admin/tnsnames.ora
#-----------------------------------------------------------------------------------------
# 添加以下内容
ORCL12 =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 10.245.230.5)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = orcl12)
    )
  )

MISORA =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 10.245.230.5)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = misora)
    )
  )

POS =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 10.240.3.39)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = posora)
    )
  )

VIP =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 10.240.3.153)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = vip)
    )
  )

YDMIS =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 10.240.3.38)(PORT = 1521))
    )
    (CONNECT_DATA =
      (SERVICE_NAME = misora)
    )
  )
#-----------------------------------------------------------------------------------------
```

## 老长宇库备份
### MIS库expdp备份
``` perl
# 表空间使用情况
select
  total.tablespace_name,
  to_char(total.MB,'999,990.99') as Total_MB,
  to_char(total.MB-free.MB, '999,990.99') as Used_MB,
  to_char((1-free.MB/total.MB)*100, '990.00') ||'%' as "% Used"
from (select tablespace_name, sum(bytes)/1024/1024 as MB from dba_free_space group by tablespace_name) free,
     (select tablespace_name, sum(bytes)/1024/1024 as MB from dba_data_files group by tablespace_name) total
where free.tablespace_name=total.tablespace_name;

TABLESPACE_NAME                TOTAL_MB    USED_MB     % Used
------------------------------ ----------- ----------- --------
UNDOTBS1                         17,324.00       17.44    0.10%
SYSAUX                              550.00      525.75   95.59%
MIS_DATA                        263,260.00  251,019.63   95.35%
USERS                                 5.00        0.44    8.75%
SYSTEM                              520.00      479.06   92.13%
MIS_INDEX                       122,880.00   84,207.50   68.53%

select name from v$tablespace;

NAME
------------------------------
SYSTEM
UNDOTBS1
SYSAUX
USERS
TEMP
MIS_TEMP
MIS_DATA
MIS_INDEX

# 用户情况
select username from dba_users 
where ACCOUNT_STATUS='OPEN' and USERNAME not in ('SYS','SYSTEM','SYSMAN','DBSNMP','MGMT_VIEW');

USERNAME
------------------------------
CY_EXP
YD
YDVIEW

select * from DBA_SYS_PRIVS where GRANTEE IN ('YD','YDVIEW','CY_EXP') order by 1,2;

GRANTEE                        PRIVILEGE                                ADM
------------------------------ ---------------------------------------- ---
CY_EXP                         SELECT ANY DICTIONARY                    NO
CY_EXP                         SELECT ANY SEQUENCE                      NO
CY_EXP                         SELECT ANY TABLE                         NO
CY_EXP                         SELECT ANY TRANSACTION                   NO
YD                             UNLIMITED TABLESPACE                     NO
YDVIEW                         SELECT ANY DICTIONARY                    NO
YDVIEW                         SELECT ANY SEQUENCE                      NO
YDVIEW                         SELECT ANY TABLE                         NO
YDVIEW                         SELECT ANY TRANSACTION                   NO

select * from DBA_ROLE_PRIVS where GRANTEE IN ('YD','YDVIEW','CY_EXP') order by 1,2;

GRANTEE                        GRANTED_ROLE                   ADM DEF
------------------------------ ------------------------------ --- ---
CY_EXP                         CONNECT                        NO  YES
YD                             CONNECT                        NO  YES
YD                             DBA                            NO  YES
YD                             EXP_FULL_DATABASE              NO  YES
YD                             IMP_FULL_DATABASE              NO  YES
YDVIEW                         CONNECT                        NO  YES

# DBLINK
col OWNER for a10
col DB_LINK for a30
col HOST for a20
select * from dba_db_links;

OWNER      DB_LINK                        USERNAME                       HOST                 CREATED
---------- ------------------------------ ------------------------------ -------------------- ------------
YD         VIP_DB                         YD_VIP                         vip                  26-JUN-14
YD         MIS_QUERY                      YD_QUERY                       mis_bk               26-JUN-14
YD         POS                            POS                            pos                  26-JUN-14


col OWNER for a10
col DIRECTORY_PATH for a50
select * from dba_directories where DIRECTORY_NAME='DUMP_DIR';

OWNER      DIRECTORY_NAME                 DIRECTORY_PATH
---------- ------------------------------ --------------------------------------------------
SYS        DUMP_DIR                       /oradata/expdp

expdp system/94a599f61f \
DIRECTORY=dump_dir \
DUMPFILE=mis_expdp_`date +%Y%m%d%H%M%S`_%U.dmp \
LOGFILE=mis_expdp_`date +%Y%m%d%H%M%S`.log \
PARALLEL=4 \
SCHEMAS=YD,YDVIEW,CY_EXP \
exclude=STATISTICS

tar -zcvf /oradata/qlnfs/changyu_bak/mis_expdp_20170620092034.tar.gz mis_expdp_20170620092034*
```

### VIP库expdp备份
``` perl
# 表空间使用情况
select
  total.tablespace_name,
  to_char(total.MB,'999,990.99') as Total_MB,
  to_char(total.MB-free.MB, '999,990.99') as Used_MB,
  to_char((1-free.MB/total.MB)*100, '990.00') ||'%' as "% Used"
from (select tablespace_name, sum(bytes)/1024/1024 as MB from dba_free_space group by tablespace_name) free,
     (select tablespace_name, sum(bytes)/1024/1024 as MB from dba_data_files group by tablespace_name) total
where free.tablespace_name=total.tablespace_name;

TABLESPACE_NAME                TOTAL_MB    USED_MB     % Used
------------------------------ ----------- ----------- --------
SYSAUX                            1,300.00    1,292.06   99.39%
SYSTEM                              790.00      784.63   99.32%
UNDOTBS1                         10,240.00    9,794.00   95.64%
USERS                                 5.00        0.44    8.75%
VIPMIS                          204,800.00  176,844.63   86.35%

select name from v$tablespace;

NAME
------------------------------
SYSTEM
UNDOTBS1
SYSAUX
USERS
TEMP
VIPMIS
VIP_TEMP

# 用户情况
select username from dba_users 
where ACCOUNT_STATUS='OPEN' and USERNAME not in ('SYS','SYSTEM','SYSMAN','DBSNMP','MGMT_VIEW')
order by 1;

USERNAME
------------------------------
CARD_CARD
CY_EXP
YDVIEW
YD_VIP
YD_VIPTEST

select * from DBA_SYS_PRIVS where GRANTEE IN ('CARD_CARD','CY_EXP','YDVIEW','YD_VIP','YD_VIPTEST') order by 1,2;

GRANTEE                        PRIVILEGE                                ADM
------------------------------ ---------------------------------------- ---
CY_EXP                         SELECT ANY DICTIONARY                    NO
CY_EXP                         SELECT ANY SEQUENCE                      NO
CY_EXP                         SELECT ANY TABLE                         NO
CY_EXP                         SELECT ANY TRANSACTION                   NO
YDVIEW                         CREATE ANY SYNONYM                       NO
YDVIEW                         CREATE DATABASE LINK                     NO
YDVIEW                         CREATE SESSION                           NO
YDVIEW                         CREATE SYNONYM                           NO
YDVIEW                         SELECT ANY DICTIONARY                    NO
YDVIEW                         SELECT ANY SEQUENCE                      NO
YDVIEW                         SELECT ANY TABLE                         NO
YDVIEW                         SELECT ANY TRANSACTION                   NO
YD_VIP                         CREATE TABLE                             NO
YD_VIP                         UNLIMITED TABLESPACE                     NO
YD_VIPTEST                     CREATE TABLE                             NO
YD_VIPTEST                     UNLIMITED TABLESPACE                     NO

select * from DBA_ROLE_PRIVS where GRANTEE IN ('CARD_CARD','CY_EXP','YDVIEW','YD_VIP','YD_VIPTEST') order by 1,2;

GRANTEE                        GRANTED_ROLE                   ADM DEF
------------------------------ ------------------------------ --- ---
CARD_CARD                      AUTHENTICATEDUSER              NO  YES
CY_EXP                         CONNECT                        NO  YES
YDVIEW                         CONNECT                        NO  YES
YD_VIP                         CONNECT                        NO  YES
YD_VIP                         DBA                            NO  YES
YD_VIPTEST                     AQ_ADMINISTRATOR_ROLE          NO  YES
YD_VIPTEST                     DBA                            NO  YES
YD_VIPTEST                     EXECUTE_CATALOG_ROLE           NO  YES

# DBLINK
col OWNER for a10
col DB_LINK for a15
col USERNAME for a10
col HOST for a60
select * from dba_db_links;

OWNER      DB_LINK         USERNAME   HOST                                                         CREATED
---------- --------------- ---------- ------------------------------------------------------------ ------------
YD_VIP     YDCYVIP         YD_BI_BK   (DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(PROTOCOL=TCP)(HOST=10.2 26-JUL-14
                                      40.4.159)(PORT=1521)))(CONNECT_DATA=(sid=bi)(SERVER = DEDICA
                                      TED)))

YD_VIP     VIP_TESTMIS     YD_TEST    misora                                                       25-JUN-13
YD_VIP     VIP_POS         POS        (DESCRIPTION =  (ADDRESS_LIST = (ADDRESS = (PROTOCOL = TCP)( 25-JUN-13
                                      HOST = 10.240.3.39)(PORT = 1521)) )(CONNECT_DATA = (SID = po
                                      sora) ) )

YD_VIP     MISORA38        YD         (DESCRIPTION = (ADDRESS_LIST = (ADDRESS = (PROTOCOL = TCP)(H 25-JUN-13
                                      OST = 10.240.3.38)(PORT = 1521)) )　(CONNECT_DATA = 　(SERVI
                                      CE_NAME = misora) 　) 　　)

YD_VIP     VIP_MISORA164   YD_TEST    mis164                                                       25-JUN-13
YD_VIP     VIP_MIS         YD         ydmis                                                        25-JUN-13
YDVIEW     VIP_MIS1        YD         ydmis                                                        25-JUN-13
YD_VIPTEST VIP_POSTEST     POS_TEST   postest                                                      25-JUN-13
YD_VIPTEST VIP_MISTEST     YD_TEST    misora1                                                      25-JUN-13
YD_VIPTEST MIS164          YD_TEST    mis164                                                       25-JUN-13

set line 150
col OWNER for a10
col DIRECTORY_PATH for a50
select * from dba_directories where DIRECTORY_NAME='DUMP_DIR';

OWNER      DIRECTORY_NAME                 DIRECTORY_PATH
---------- ------------------------------ --------------------------------------------------
SYS        DUMP_DIR                       /oradata/dumpdir

expdp system/94a599f61f \
DIRECTORY=dump_dir \
DUMPFILE=vip_expdp_`date +%Y%m%d%H%M%S`_%U.dmp \
LOGFILE=vip_expdp_`date +%Y%m%d%H%M%S`.log \
PARALLEL=4 \
SCHEMAS=CARD_CARD,CY_EXP,YDVIEW,YD_VIP,YD_VIPTEST \
exclude=STATISTICS

tar -zcvf /oradata/qlnfs/changyu_bak/vip_expdp_20170620142116.tar.gz vip_expdp_20170620142116*
```

## IMPDP迁移到12C
### MISORA迁移
``` perl
# 关闭归档
sqlplus / as sysdba

alter session set containter=MISORA;
create user YD identified by misora_yd2014;
create user YDVIEW identified by ydview_cy2014;
create user CY_EXP identified by misora_yd2014;

shutdown immediate
startup mount
alter database noarchivelog;
alter database open;

cd /oradata/dumpdir
tar xvpf /oradata/qlnfs/changyubak/mis_expdp_20170620092034.tar.gz
mis_expdp_20170620092034_01.dmp
mis_expdp_20170620092034_02.dmp
mis_expdp_20170620092034_03.dmp
mis_expdp_20170620092034_04.dmp
mis_expdp_20170620092034.log

impdp system/j12ja7or1Q@misora \
DIRECTORY=dump_dir \
DUMPFILE=mis_expdp_20170620092034_%U.dmp \
LOGFILE=misora_impdp_`date +%Y%m%d%H%M%S`.log \
SCHEMAS=YD,YDVIEW,CY_EXP

sqlplus / as sysdba
alter session set containter=MISORA;

set line 150
set pagesize 9999
col FILE_NAME for a80

select file_name,BYTES/1024/1024 size_m from dba_data_files
union all
select file_name,BYTES/1024/1024 size_m from dba_temp_files order by 1;

FILE_NAME                                                                            SIZE_M
-------------------------------------------------------------------------------- ----------
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_data.257.947174203         20480
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_data.258.947174169         20480
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_data.272.947174135         20480
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_data.281.947174309         20480
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_data.282.947174239         20480
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_data.283.947174275         20480
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_data.284.947174345         20480
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_data.285.947174381         20480
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_data.287.947174415         20480
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_data.288.947174451         20480
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_data.289.947174487         20480
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_data.290.947174523         20480
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_data.291.947174559         20480
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_data.292.947174595         20480
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_index.293.947174657        20480
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_index.294.947174693        20480
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_index.295.947174731        20480
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_index.296.947174767        20480
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/mis_index.297.947174803        20480
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/sysaux.266.947174121             225
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/system.273.947174121             300
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/DATAFILE/undotbs1.274.947174121           285
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/TEMPFILE/temp.267.947174125             10024
+DATA/ORCL12/526092C61E62887EE05305E6F50A260D/TEMPFILE/temp.313.947178809             10024

select
  total.tablespace_name,
  to_char(total.MB,'999,990.99') as Total_MB,
  to_char(total.MB-free.MB, '999,990.99') as Used_MB,
  to_char((1-free.MB/total.MB)*100, '990.00') ||'%' as "% Used"
from (select tablespace_name, sum(bytes)/1024/1024 as MB from dba_free_space group by tablespace_name) free,
     (select tablespace_name, sum(bytes)/1024/1024 as MB from dba_data_files group by tablespace_name) total
where free.tablespace_name=total.tablespace_name
union all
select tablespace_name,
  to_char(TABLESPACE_SIZE/1024/1024, '999,990.99') as Total_MB,
  to_char((TABLESPACE_SIZE-FREE_SPACE)/1024/1024, '999,990.99') as Used_MB,
  to_char(((TABLESPACE_SIZE-FREE_SPACE)/TABLESPACE_SIZE)*100,'990.00') ||'%' as "% Used"
from dba_temp_free_space order by 1;

TABLESPACE_NAME                TOTAL_MB    USED_MB     % Used
------------------------------ ----------- ----------- --------
MIS_DATA                        286,720.00  250,962.69   87.53%
MIS_INDEX                       102,400.00   83,015.56   81.07%
SYSAUX                              225.00      213.44   94.86%
SYSTEM                              300.00      234.63   78.21%
TEMP                             20,048.00        2.00    0.01%
UNDOTBS1                            285.00       34.00   11.93%

exec DBMS_STATS.GATHER_DATABASE_STATS;
exec DBMS_STATS.GATHER_DATABASE_STATS_JOB_PROC;

select 'exec DBMS_STATS.GATHER_SCHEMA_STATS(OWNNAME=>''' || username || ''');'
from dba_users 
where ACCOUNT_STATUS='OPEN' and USERNAME not in ('SYS','SYSTEM','SYSMAN','DBSNMP','MGMT_VIEW')
order by 1;

'DBMS_STATS.GATHER_SCHEMA_STATS(OWNNAME==>'''||USERNAME||''');'
--------------------------------------------------------------------------------
exec DBMS_STATS.GATHER_SCHEMA_STATS(OWNNAME=>'CY_EXP');
exec DBMS_STATS.GATHER_SCHEMA_STATS(OWNNAME=>'PDB_MGR');
exec DBMS_STATS.GATHER_SCHEMA_STATS(OWNNAME=>'YD');
exec DBMS_STATS.GATHER_SCHEMA_STATS(OWNNAME=>'YDVIEW');

set line 150
col OWNER for a20
col JOB_NAME for a30
SELECT OWNER,JOB_NAME,TO_CHAR(LAST_START_DATE,'YYYY-MM-DD HH24:MI:SS'),TO_CHAR(LAST_RUN_DURATION,'YYYY-MM-DD HH24:MI:SS')
  FROM DBA_SCHEDULER_JOBS
  WHERE JOB_NAME like '%STATS%';
```

### VIP迁移
``` perl
# 关闭归档(上面做完了，这步可以忽略)
sqlplus / as sysdba

# 创建用户
alter session set container=vip;
create user CARD_CARD identified by card_cy2014;
create user CY_EXP identified by vip_cy2014;
create user YDVIEW identified by ydview_cy2014;
create user YD_VIP identified by vip_cy2014;
create user YD_VIPTEST identified by vip_cy2014;

cd /oradata/dumpdir
tar xvpf /oradata/qlnfs/changyu_bak/vip_expdp_20170620142116.tar.gz 
vip_expdp_20170620142116_01.dmp
vip_expdp_20170620142116_02.dmp
vip_expdp_20170620142116_03.dmp
vip_expdp_20170620142116_04.dmp
vip_expdp_20170620142116.log

vi $ORACLE_HOME/network/admin/tnsnames.ora
#---------------------------------------------------------------------
# 修改以下内容
VIP =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 10.245.230.5)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = vip)
    )
  )
#---------------------------------------------------------------------

impdp system/j12ja7or1Q@vip \
DIRECTORY=dump_dir \
DUMPFILE=vip_expdp_20170620142116_%U.dmp \
LOGFILE=vip_impdp_`date +%Y%m%d%H%M%S`.log \
SCHEMAS=CARD_CARD,CY_EXP,YDVIEW,YD_VIP,YD_VIPTEST

sqlplus / as sysdba
alter session set container=vip;

set line 150
set pagesize 9999
col FILE_NAME for a80
select file_name,BYTES/1024/1024 size_m from dba_data_files
union all
select file_name,BYTES/1024/1024 size_m from dba_temp_files order by 1;

FILE_NAME                                                                            SIZE_M
-------------------------------------------------------------------------------- ----------
+DATA/ORCL12/525F6941825FE32DE05305E6F50A9CD5/DATAFILE/sysaux.298.947169131             225
+DATA/ORCL12/525F6941825FE32DE05305E6F50A9CD5/DATAFILE/system.299.947169131             300
+DATA/ORCL12/525F6941825FE32DE05305E6F50A9CD5/DATAFILE/undotbs1.300.947169131           220
+DATA/ORCL12/525F6941825FE32DE05305E6F50A9CD5/DATAFILE/vipmis.302.947169285           20480
+DATA/ORCL12/525F6941825FE32DE05305E6F50A9CD5/DATAFILE/vipmis.303.947169321           20480
+DATA/ORCL12/525F6941825FE32DE05305E6F50A9CD5/DATAFILE/vipmis.304.947169355           20480
+DATA/ORCL12/525F6941825FE32DE05305E6F50A9CD5/DATAFILE/vipmis.305.947169391           20480
+DATA/ORCL12/525F6941825FE32DE05305E6F50A9CD5/DATAFILE/vipmis.306.947169427           20480
+DATA/ORCL12/525F6941825FE32DE05305E6F50A9CD5/DATAFILE/vipmis.307.947169463           20480
+DATA/ORCL12/525F6941825FE32DE05305E6F50A9CD5/DATAFILE/vipmis.308.947169499           20480
+DATA/ORCL12/525F6941825FE32DE05305E6F50A9CD5/DATAFILE/vipmis.309.947169535           20480
+DATA/ORCL12/525F6941825FE32DE05305E6F50A9CD5/DATAFILE/vipmis.310.947169571           20480
+DATA/ORCL12/525F6941825FE32DE05305E6F50A9CD5/DATAFILE/vipmis.311.947169609           20480
+DATA/ORCL12/525F6941825FE32DE05305E6F50A9CD5/TEMPFILE/temp.301.947169135              8094

select
  total.tablespace_name,
  to_char(total.MB,'999,990.99') as Total_MB,
  to_char(total.MB-free.MB, '999,990.99') as Used_MB,
  to_char((1-free.MB/total.MB)*100, '990.00') ||'%' as "% Used"
from (select tablespace_name, sum(bytes)/1024/1024 as MB from dba_free_space group by tablespace_name) free,
     (select tablespace_name, sum(bytes)/1024/1024 as MB from dba_data_files group by tablespace_name) total
where free.tablespace_name=total.tablespace_name
union all
select tablespace_name,
  to_char(TABLESPACE_SIZE/1024/1024, '999,990.99') as Total_MB,
  to_char((TABLESPACE_SIZE-FREE_SPACE)/1024/1024, '999,990.99') as Used_MB,
  to_char(((TABLESPACE_SIZE-FREE_SPACE)/TABLESPACE_SIZE)*100,'990.00') ||'%' as "% Used"
from dba_temp_free_space order by 1;

TABLESPACE_NAME                TOTAL_MB    USED_MB     % Used
------------------------------ ----------- ----------- --------
SYSAUX                              225.00      208.44   92.64%
SYSTEM                              300.00      198.13   66.04%
TEMP                              8,094.00        1.00    0.01%
UNDOTBS1                            220.00      124.56   56.62%
VIPMIS                          204,800.00  170,837.00   83.42%

exec DBMS_STATS.GATHER_DATABASE_STATS;
exec DBMS_STATS.GATHER_DATABASE_STATS_JOB_PROC;

select 'exec DBMS_STATS.GATHER_SCHEMA_STATS(OWNNAME=>''' || username || ''');'
from dba_users 
where ACCOUNT_STATUS='OPEN' and USERNAME not in ('SYS','SYSTEM','SYSMAN','DBSNMP','MGMT_VIEW')
order by 1;

'DBMS_STATS.GATHER_SCHEMA_STATS(OWNNAME==>'''||USERNAME||''');'
--------------------------------------------------------------------------------
exec DBMS_STATS.GATHER_SCHEMA_STATS(OWNNAME=>'CARD_CARD');
exec DBMS_STATS.GATHER_SCHEMA_STATS(OWNNAME=>'CY_EXP');
exec DBMS_STATS.GATHER_SCHEMA_STATS(OWNNAME=>'PDB_MGR');
exec DBMS_STATS.GATHER_SCHEMA_STATS(OWNNAME=>'YDVIEW');
exec DBMS_STATS.GATHER_SCHEMA_STATS(OWNNAME=>'YD_VIP');
exec DBMS_STATS.GATHER_SCHEMA_STATS(OWNNAME=>'YD_VIPTEST');
```


## 杂项
### 将/dev/sda10添加到root目录
``` perl
xfs_info /dev/ol/root

xfs_growfs /dev/ol/root

df -hT
Filesystem          Type      Size  Used Avail Use% Mounted on
devtmpfs            devtmpfs   63G     0   63G   0% /dev
tmpfs               tmpfs      63G  640M   63G   1% /dev/shm
tmpfs               tmpfs      63G  9.2M   63G   1% /run
tmpfs               tmpfs      63G     0   63G   0% /sys/fs/cgroup
/dev/mapper/ol-root xfs       442G   48G  395G  11% /
/dev/sda2           xfs      1014M  148M  867M  15% /boot
/dev/sda1           vfat      200M  9.5M  191M   5% /boot/efi
tmpfs               tmpfs      13G     0   13G   0% /run/user/54322
tmpfs               tmpfs      13G     0   13G   0% /run/user/0
```

### 老VIP库tnsnames配置
``` perl
VIP =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = vip)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = vip)
    )
  )

YDMIS =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 10.240.3.38)(PORT = 1521))
    )
    (CONNECT_DATA =
      (SERVICE_NAME = misora)
    )
  )

MISORA =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 10.240.3.37)(PORT = 1521))
    )
    (CONNECT_DATA =
      (SERVICE_NAME = misora)
    )
  )

MIS164 =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 10.240.3.164)(PORT = 1521))
    )
    (CONNECT_DATA =
      (SERVICE_NAME = misora1)
    )
  )


POSORA =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 10.240.3.39)(PORT = 1521))
    )
    (CONNECT_DATA =
      (SERVICE_NAME = posora)
    )
  )
```

### MISOLD迁移步骤概要
``` perl
create or replace directory DUMP_DIR as '/oradata/dumpdir';

mkdir /oradata/dumpdir

expdp system/Center08 \
DIRECTORY=dump_dir \
DUMPFILE=misold_expdp_`date +%Y%m%d%H%M%S`_%U.dmp \
LOGFILE=misold_expdp_`date +%Y%m%d%H%M%S`.log \
PARALLEL=4 \
COMPRESSION=ALL \
SCHEMAS=YD \
exclude=STATISTICS

create pluggable database misold admin user pdb_mgr identified by "j12ja7or1Q"
default tablespace misora datafile
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited,
  '+DATA' size 20g autoextend on next 500m maxsize unlimited;

alter pluggable database misold open;
alter pluggable database misold save state;
alter session set container=misold;

create user yd identified by 111111;

vi $ORACLE_HOME/network/admin/tnsnames.ora

MISOLD =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 10.245.230.5)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = misold)
    )
  )

su - gird
vi $ORACLE_HOME/network/admin/listener.ora

SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (GLOBAL_DBNAME = misora)
      (ORACLE_HOME = /u01/app/oracle/product/12.2.0/db_1)
      (SID_NAME = orcl12)
    )
    (SID_DESC =
      (GLOBAL_DBNAME = vip)
      (ORACLE_HOME = /u01/app/oracle/product/12.2.0/db_1)
      (SID_NAME = orcl12)
    )
    (SID_DESC =
      (GLOBAL_DBNAME = misold)
      (ORACLE_HOME = /u01/app/oracle/product/12.2.0/db_1)
      (SID_NAME = orcl12)
    )
)


lsnrctl reload
exit
su - oracle
sqlplus system/j12ja7or1Q@misold
create or replace directory dump_dir as '/oradata/dumpdir';

tar xvpf /oradata/qlnfs/changyu_bak/misold_expdp_20170622171003.tar.gz 
misold_expdp_20170622171003_01.dmp
misold_expdp_20170622171003_02.dmp
misold_expdp_20170622171003_03.dmp
misold_expdp_20170622171003_04.dmp
misold_expdp_20170622171003.log

impdp system/j12ja7or1Q@misold \
DIRECTORY=dump_dir \
DUMPFILE=misold_expdp_20170622171003_%U.dmp \
LOGFILE=misold_impdp_`date +%Y%m%d%H%M%S`.log \
SCHEMAS=yd
```
